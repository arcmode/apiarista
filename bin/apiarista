#!/usr/bin/env node

/**
 * Module dependencies.
 */

var program = require('commander'),
    async = require('async'),
    wrench = require('wrench'),
    path = require('path'),
    os = require('os'),
    fs = require('fs'),
    child_process = require('child_process'),
    replace = require('replace');

// CLI

program
  .version(require('../package').version)
  .option('-i, install', 'install base api')
  .option('-r, resource [ResourceName]', 'generate resource')
  .option('-o, --owned', 'set an owner field for the resource')
  .option('-t, --timestamp', 'add timestamp field to resource')
  .option('-f, --force', 'force resource creation')
  .option('-d, --debug', 'debug mode');

// custom help

program.on('--help', function(){
  console.log('  Examples:');
  console.log('');
  console.log('    $ apiarista init');
  console.log('    $ apiarista resource blog name:String');
  console.log('    $ apiarista resource Blog "name : { type: String }"');
  console.log('    $ apiarista resource Has "blog : { type: ObjectId, ref: \'Blog\' }" --owned --timestamp');
  console.log('');
});

// parse arguments

program.parse(process.argv);

var install = program.install,
    resource = program.resource;

// utility to propercase the resource name

String.prototype.toProperCase = function () {
    return this.replace(/\w\S*/g, function(txt){return txt.charAt(0).toUpperCase() + txt.substr(1).toLowerCase();});
};

// names

var resourceName = program.resource,
    lowerName = program.resource.toLowerCase(),
    properName = program.resource.toProperCase();

// end-of-line code

var eol = 'win32' == os.platform() ? '\r\n' : '\n';

// dirs to operate

var templateDir = path.join(__dirname, '../node_modules/apiarista-template'),
    currentDir = process.cwd();

// data used during operations

var data = {
  methods: {
      testApp: testApp
    , createCommonDirs: createCommonDirs
    , createCommonFiles: createCommonFiles
    , checkResourceExistence: checkResourceExistence
    , createResource: createResource
    , replaceNames: replaceNames
    , upgradeSchema: upgradeSchema
    , replaceConditionals: replaceConditionals
    , upgradeApiIndex: upgradeApiIndex
    , updateDependencies: updateDependencies
  },
  pipeline: [testApp],
  mkdirMode: 0777 & (~process.umask()),
  app: undefined,
  absent: [],
  present: [],
  created: []
}

// build pipeline

if (install) {

  data.pipeline.push(
                      data.methods.createCommonDirs,
                      data.methods.createCommonFiles,
                      data.methods.updateDependencies
                    );

} else if (resource && typeof resource === 'string') {

  data.pipeline.push(
                      data.methods.createCommonDirs,
                      data.methods.createCommonFiles
                    );

  if (!program.force) { data.pipeline.push(data.methods.checkResourceExistence); }

  data.pipeline.push(
                      data.methods.createResource,
                      data.methods.replaceNames,
                      data.methods.upgradeSchema,
                      data.methods.replaceConditionals,
                      data.methods.upgradeApiIndex,
                      data.methods.updateDependencies
                    );
} else {

  abort('    you  must specify a name')
}

// operate in series

async.series(data.pipeline, function(err, results){

  if (err) { abort(err); }

  console.log();

  console.log(results);

  if (program.debug) {

    console.log('    DEBUG    ');

    console.log();

    console.log(data);
  }
  console.log();
});

/**
 * Test process.cwd() is a Node.js application.
 *
 * Abort unless api.js or server.js are founded (not recursive).
 */

function testApp(callback){
  fs.exists(path.join(currentDir, '/app.js'), function(exists){
    if (exists) {
      data.app = '/app.js';
      data.present.push(data.app);
      callback(null, data.app);
    } else {
      fs.exists(path.join(currentDir, '/server.js'), function(exists){
        if (exists) {
          data.app = '/server.js';
          data.present.push(data.app);
          callback(null, data.app);
        } else {
          data.absent.push(data.app);
          abort('    app/server not found')
        }
      });
    }
  });
};

/**
 * Create base dirs.
 *
 * Create data, api and subdirs.
 */

function createCommonDirs(callback) {
  var dirs = [
    '/data',
    '/data/schemas',
    '/data/models',
    '/data/config',
    '/data/utils',
    '/api',
    '/api/auth',
    '/api/resources',
    '/api/resources/consumer',
    '/api/resources/consumer/crud',
    '/api/resources/user',
    '/api/resources/user/crud'
  ];

  dirs.forEach(function(dir){
    dirPath = path.join(currentDir, dir);
        exists = fs.existsSync(dirPath);
    if (exists) {
      data.present.push(dirPath);
    } else {
      data.absent.push(dirPath);
      fs.mkdirSync(dirPath, data.mkdirMode);
      data.created.push(dirPath);
    }
  });
  callback(null, 'createCommonDirs');
};

/**
 * Create base files.
 *
 * Create api middlewares and user and consumer resources including schema, model and crud.
 */

function createCommonFiles(callback) {
  var files = [
    '/data/schemas/user.js',
    '/data/schemas/consumer.js',
    '/data/models/user.js',
    '/data/models/consumer.js',
    '/data/config/db.js',
    '/data/utils/tokenize.js',
    '/api/index.js',
    '/api/auth/user.js',
    '/api/auth/consumer.js',
    '/api/auth/same.js',
    '/api/auth/owner.js',
    '/api/resources/user/index.js',
    '/api/resources/user/crud/list.js',
    '/api/resources/user/crud/create.js',
    '/api/resources/user/crud/read.js',
    '/api/resources/user/crud/update.js',
    '/api/resources/user/crud/delete.js',
    '/api/resources/consumer/index.js',
    '/api/resources/consumer/crud/create.js',
    '/api/resources/consumer/crud/delete.js'
  ];

  files.forEach(function(file){
    var filePath = path.join(currentDir, file),
        exists = fs.existsSync(filePath);
    if (exists) {
      data.present.push(filePath);
    } else {
      var templateFilePath = path.join(templateDir, file),
          templateFileContent = fs.readFileSync(templateFilePath);
      data.absent.push(filePath)
      fs.writeFileSync(filePath, templateFileContent, 'utf8');
      data.created.push(filePath)
    }
  });
  callback(null, 'createCommonFiles');
}

/**
 * Check existence of resource files.
 *
 * Aborts when one of the paths exists.
 */

function checkResourceExistence(callback){
      paths = [
        '/data/schemas/' + resourceName + '.js',
        '/data/models/' + resourceName + '.js',
        '/api/resources/' + resourceName + '/index.js',
        '/api/resources/' + resourceName + '/crud/list.js',
        '/api/resources/' + resourceName + '/crud/create.js',
        '/api/resources/' + resourceName + '/crud/read.js',
        '/api/resources/' + resourceName + '/crud/update.js',
        '/api/resources/' + resourceName + '/crud/delete.js'
      ];

  paths.forEach(function(_path){
    var realPath = path.join(currentDir, _path),
        exists = fs.existsSync(realPath);
    if (exists) {
      data.present.push(realPath);
      callback(new Error('exists -> ' + realPath));
    } else {
      data.absent.push(realPath);
    }
  });
  callback(null, 'checkResourceExistence')
}

/**
 * Create schema, model and crud for resource.
 *
 */

function createResource(callback){
      paths = function(name){
        var defaultName = 'resource';
        resource = (name && name.toLowerCase()) || defaultName;
        var p = [
          '/data/schemas/' + resource + '.js',
          '/data/models/' + resource + '.js',
          '/api/resources/' + resource,
          '/api/resources/' + resource + '/index.js',
          '/api/resources/' + resource + '/crud',
          '/api/resources/' + resource + '/crud/list.js',
          '/api/resources/' + resource + '/crud/create.js',
          '/api/resources/' + resource + '/crud/read.js',
          '/api/resources/' + resource + '/crud/update.js',
          '/api/resources/' + resource + '/crud/delete.js'
        ];
        return p;
      }

  paths(resourceName).forEach(function(resourcePath, index){
    var targetRealPath = path.join(currentDir, resourcePath),
        exists = fs.existsSync(targetRealPath);
    if (exists) {
      data.present.push(targetRealPath);
    } else {
      data.absent.push(targetRealPath)
      var ext = path.extname(targetRealPath);
      if (ext !== '.js') {
        fs.mkdirSync(targetRealPath, data.mkdirMode);
      } else {
        var originRealPath = path.join(templateDir, paths()[index]),
          templateFileContent = fs.readFileSync(originRealPath);
        fs.writeFileSync(targetRealPath, templateFileContent, 'utf8');
      }
      data.created.push(targetRealPath)
    }
  });
  callback(null, 'createResource');
};

/**
 * Replace the default resource name with 'program.resource.toProperCase()'.
 *
 */

function replaceNames(callback){

  // resource paths
  var paths = [
    path.join(currentDir, '/data/schemas/' + lowerName + '.js'),
    path.join(currentDir, '/data/models/' + lowerName + '.js'),
    path.join(currentDir, '/api/resources/' + lowerName)
  ];

  // add a pluralize() function to the member named 'resources'
  var forReplace = [
    { from: 'resources', to: lowerName + 's' },
    { from: 'Resources', to: properName + 's' },
    { from: 'resource', to: lowerName },
    { from: 'resource_id', to: lowerName + '_id' },
    { from: 'Resource', to: properName }
  ];

  // replace resource name
  forReplace.forEach(function(replacement){
    var from = replacement.from,
        to = replacement.to;
    replace({
      regex: from,
      replacement: to,
      paths: paths,
      recursive: true,
      silent: true
    });
  });

  // replace db connection name
  replace({
    regex: 'apiarista-template',
    replacement: path.basename(currentDir),
    paths: [path.join(currentDir, '/data/config/db.js')],
    recursive: false,
    silent: true
  });

  callback(null , 'replaceNames');
}

/**
 * Upgrade the generated Schema.
 *
 * Add fields from program options data.
 *
 */

function upgradeSchema(callback){

  var targetPath = path.join(currentDir, '/data/schemas/' + lowerName + '.js'),
      fields = program.args,
      code = [],
      leftSpace = '  ';

  for (var i = 0; i < fields.length; i++) {
    code.push(leftSpace + ', ' + fields[i]);
  };

  if (code.length) {
    code[0] = ' ' + code[0].slice(3);
  }

  code = code.join(eol);

  var argsFields = {
    regex: '\/\/FIELDS PLACEHOLDER',
    replacement: code,
    paths: [targetPath],
    recursive: false,
    silent: true,
  };

  replace(argsFields);
  callback(null, 'upgradeSchema');
};

/**
 * Replace conditional code.
 *
 * If program.owned then //IF-OWNED is removed
 *
 */

function replaceConditionals(callback){

  // --owner -o, --timestamp -t
  var owned = program.owned,
      timestamp = program.timestamp;

  // relevant paths
  var paths = [
    path.join(currentDir, '/data/schemas'),
    path.join(currentDir, '/api/resources/' + lowerName)
  ];

  // remove //IF-OWNED
  if (owned) {
    var argsOwner = {
      regex: '\/\/IF-OWNED ',
      replacement: '',
      paths: paths,
      recursive: true,
      silent: true,
    };
    replace(argsOwner);
  }

  // remove //IF-TIMESTAMP
  if (timestamp) {
    var argsOwner = {
      regex: '\/\/IF-TIMESTAMP ',
      replacement: '',
      paths: paths,
      recursive: true,
      silent: true,
    };
    replace(argsOwner);
  }

  callback(null, 'replaceConditionals');
};

/**
 * Upgrade api/index.js routes.
 *
 * Add resource to api index for routing.
 *
 */

function upgradeApiIndex(callback){
  var targetPath = path.join(currentDir, '/api/index.js'),
      code = [],
      leftSpace = '  ';

  code.push('//CRUDs PLACEHOLDER');
  code.push('');
  code.push(leftSpace + 'require(\'./resources/' + lowerName  + '\')(app);');

  code = code.join(eol);

  var args = {
    regex: '\/\/CRUDs PLACEHOLDER',
    replacement: code,
    paths: [targetPath],
    recursive: false,
    silent: true,
  };

  replace(args);
  callback(null, 'upgradeApiIndex');
};

/**
 * Update app dependencies with apiarist-template dependencies.
 *
 */

function updateDependencies(callback){
  var targetPkgPath = path.join(currentDir, '/package.json'),
      targetPkg = require(targetPkgPath),
      originPkgPath = path.join(templateDir, '/package.json'),
      originPkg = require(originPkgPath);

  // load target pkg
  var merge = targetPkg;

  // dont merge irrelevant dependencies
  var exclude = {
    "jade": "*",
    "stylus": "*"
  };

  // add origin dependencies
  for (var key in originPkg.dependencies){
    if (!merge.dependencies.hasOwnProperty(key) && !(key in exclude)) {
      merge.dependencies[key] = originPkg.dependencies[key];
    }
  }

  // write updated pkg
  fs.writeFileSync(targetPkgPath, JSON.stringify(merge, null, 4));

  callback(null, 'updateDependencies');
};

/**
 * Borrowed from '/express/bin'.
 *
 * Exit with the given `str`.
 *
 * @param {String} str
 */

function abort(str) {
  console.log();
  console.error('    ' + str);
  console.log();
  process.exit(1);
}